{
    "sql": [
        "CREATE USER reader REQUIRE ISSUER '/CN=Owner CA' SUBJECT '/CN=Reader'",
        "CREATE USER writer REQUIRE ISSUER '/CN=Owner CA' SUBJECT '/CN=Writer'",
        "CREATE USER fakeUser ACCOUNT LOCK",
        "CREATE DATABASE attribution",
        "CREATE TABLE attribution.reports (id MEDIUMINT NOT NULL AUTO_INCREMENT, match_key INT, is_trigger BOOL, value INT, breakdown_key INT, PRIMARY KEY (id))",
        "CREATE TABLE attribution.aggregated (id MEDIUMINT AUTO_INCREMENT, value INT DEFAULT 0, PRIMARY KEY (id))",
        "CREATE DEFINER=writer PROCEDURE attribution.init_aggregated(breakdown INT) BEGIN DECLARE i INT DEFAULT 0;SET i=0; SET i =0; WHILE i<breakdown DO  INSERT INTO attribution.aggregated SET value = 0; SET i=i+1; END WHILE; END",
        "CREATE DEFINER=fakeUser PROCEDURE attribution.match(OUT breakdown_source INT, IN trigger_id INT, IN trigger_key INT) BEGIN SELECT MAX(id), breakdown_key INTO @max, @breakdown_source FROM attribution.reports WHERE is_trigger = 0 AND match_key = @trigger_key AND id < @trigger_id; END",
        "CREATE DEFINER=fakeUser PROCEDURE attribution.select_row(IN i INT, OUT trigger_key INT, OUT trigger_id INT, OUT trigger_value INT, OUT row_is_trigger INT) BEGIN SELECT id, match_key, value, is_trigger INTO @trigger_id, @trigger_key, @trigger_value, @row_is_trigger FROM attribution.reports WHERE id = i; END",
        "CREATE DEFINER=fakeUser PROCEDURE attribution.output(IN breakdown_input INT) BEGIN DECLARE n INT DEFAULT 0; DECLARE i INT DEFAULT 0; DECLARE trigger_key INT DEFAULT 0; DECLARE trigger_id INT DEFAULT 0; DECLARE breakdown_source INT DEFAULT 0; DECLARE row_is_trigger INT DEFAULT 0; DECLARE trigger_value INT DEFAULT 0; DECLARE sum INT DEFAULT 0; SELECT COUNT(*) FROM attribution.reports INTO n; SET i=0; SET sum=0; WHILE i<n DO SET @row_is_trigger = 0; CALL attribution.select_row(i, trigger_key, trigger_id, trigger_value, row_is_trigger); IF @row_is_trigger = 1 THEN CALL attribution.match(breakdown_source, trigger_id, trigger_key); IF @breakdown_source = breakdown_input THEN SET sum = sum + @trigger_value; END IF; END IF; SET i = i + 1; END WHILE; SELECT sum; END",
        "CREATE DEFINER=fakeUser PROCEDURE attribution.match_opt(OUT breakdown_source INT, IN trigger_id INT, IN trigger_key INT) BEGIN SELECT MAX(id), breakdown_key INTO @max, @breakdown_source FROM attribution.reports WHERE is_trigger = 0 AND match_key = trigger_key AND id < trigger_id; END",
        "CREATE DEFINER=fakeUser PROCEDURE attribution.output_opt() BEGIN  DECLARE done INT DEFAULT FALSE; DECLARE trigger_key INT DEFAULT 0; DECLARE trigger_id INT DEFAULT 0; DECLARE breakdown_source INT DEFAULT 0; DECLARE trigger_value INT DEFAULT 0; DECLARE sum INT DEFAULT 0; DECLARE cur1 CURSOR FOR SELECT id, match_key, value FROM attribution.reports WHERE is_trigger = 1; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; OPEN cur1; read_loop: LOOP FETCH cur1 INTO trigger_id, trigger_key, trigger_value; IF done THEN LEAVE read_loop; END IF; CALL attribution.match_opt(breakdown_source, trigger_id, trigger_key); UPDATE attribution.aggregated SET value = value + trigger_value WHERE id = @breakdown_source; END LOOP; SELECT id, value FROM attribution.aggregated; END",
        "GRANT EXECUTE ON PROCEDURE attribution.output_opt TO fakeUser",
        "GRANT EXECUTE ON PROCEDURE attribution.output TO fakeUser",
        "GRANT EXECUTE ON PROCEDURE attribution.match TO fakeUser",
        "GRANT EXECUTE ON PROCEDURE attribution.select_row to fakeUser",
        "GRANT EXECUTE ON PROCEDURE attribution.match_opt TO fakeUser",
        "GRANT INSERT ON attribution.reports TO writer",
        "GRANT INSERT ON attribution.aggregated TO writer",
        "GRANT EXECUTE ON PROCEDURE attribution.init_aggregated TO writer",
        "GRANT SELECT ON attribution.reports TO fakeUser",
        "GRANT INSERT ON attribution.aggregated TO fakeUser",
        "GRANT SELECT ON attribution.aggregated TO fakeUser",
        "GRANT UPDATE ON attribution.aggregated TO fakeUser",
        "GRANT EXECUTE ON PROCEDURE attribution.output TO reader",
        "GRANT EXECUTE ON PROCEDURE attribution.output_opt TO reader",
        "GRANT SELECT ON attribution.aggregated TO reader",
        "CREATE INDEX match_key_index ON attribution.reports(match_key)",
        "CREATE INDEX is_trigger_index ON attribution.reports(is_trigger ASC)"
    ],
    "ca": "-----BEGIN CERTIFICATE-----\nMIIDBzCCAe+gAwIBAgIUdnImbY1CSHmdZ3zvho28SAmBFD4wDQYJKoZIhvcNAQEL\nBQAwEzERMA8GA1UEAwwIT3duZXIgQ0EwHhcNMjIxMjE2MDg1NjMxWhcNMzIxMjEz\nMDg1NjMxWjATMREwDwYDVQQDDAhPd25lciBDQTCCASIwDQYJKoZIhvcNAQEBBQAD\nggEPADCCAQoCggEBAMuuyaOOj2D2E8jY+P3Lz72s73rt/RyY7aPqphuDXdVg2P8f\nrokaVQCPZxRjb0G7qjUdOtNnBN8x5rACJoAKMd9dE+5JDDqs8J41/32rarlo/iXo\ntsOa3vU5YQHGl3rhDw0ztO9OpLED1pzxeFenVa4oSr+LsWrmICMXYTWLO/1Ya+Bu\nOf2xZJFyv/oI/RvCDQ3FXZdoTnt6RispT7w9jLF7uh+i2sM8SO3wTRqUmRWLbRBH\nk6WlKRQILiQ8G5c8ORstGxqc8bWIA02V1lzxyfbiPhhW58zz8hh67cUrZfAGQxQG\nrgUWzte9KgOROUjU0MOTFYBJEVCmM3VrO5GiHTUCAwEAAaNTMFEwHQYDVR0OBBYE\nFE2IQ7gqVCap2+kQs4WSov5VMJe/MB8GA1UdIwQYMBaAFE2IQ7gqVCap2+kQs4WS\nov5VMJe/MA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAHCqzd8r\n/E1dmA/ubhD3mdVfuNfU7p8Z2ccxWYmUDP99jJNQmh7DPBs1v04HeQi1eKZvOMqg\nkl5RlXWLgtDWefTp97aPvN327ZStQFUK//nbPpeuplTFJTSERVXPk8KqCRaoJQiI\nDHMQLxz3t3R6xIEUe345gbDc7PKS9VwLImcpcHJjR93N6ffXTiGMvn1S+khqwM5+\naLGIRh3ioJWseiFPJg40JXICuHgs6AUntbT2uigY8HIntC2j64kOEZIpUgdE6SsY\nsjuvk0T/RTcQhaysEZEM2Xx9bl6gY4M2nce4J5+M26xEsek3RS7pZX/0172W1gAL\nHb57oVAAcz6tSjQ=\n-----END CERTIFICATE-----\n"
}